## フロントエンド・リファクタリング計画（GameChat AI）

### 1. 現状のコード構成（要点）

#### ディレクトリ構成

* `src/components/`：UI部品（`ui/`配下にButton, Input, Sidebar等のAtomic Design的な粒度の部品あり）
* `src/app/`：Next.jsのApp Router構成。layout.tsx, page.tsx, assistant.tsxなどページ・レイアウト単位で分割
* `src/hooks/`：カスタムフック（PWA, WebVitals, モバイル判定等）
* `src/lib/`：ユーティリティ・APIクライアント・外部連携（firebase, sentry, utils等）

#### 型安全性

* TypeScriptで実装されているが、tsconfig.jsonの`strict`がfalse（型安全性が甘い）

#### テスト

* `@testing-library/react`と`vitest`導入済み（`__tests__`配下にサンプルのみ）

#### エラーハンドリング・監視

* Sentry, ErrorBoundary, GlobalErrorHandlerなど堅牢な設計

#### PWA/パフォーマンス

* PWA対応、Web Vitals計測、Service Worker登録済み

---

### 2. 主な課題点

* **型安全性**

  * `strict: false` → 厳格な型定義が必要
  * `any`型や型推論任せの箇所が存在

* **コンポーネントの粒度と責務**

  * `assistant.tsx`などのページコンポーネントが肥大化
  * props型の明示と分離が必要

* **テスト**

  * 単体テストがサンプルレベルで主要機能が未テスト
  * E2Eテストが不足

* **ディレクトリ構成**

  * Atomic Designや機能単位（Feature-based）の構成整理が不十分

* **スタイルの統一性**

  * Tailwindクラスの一貫性に課題

* **依存パッケージ**

  * 未使用や古いパッケージが残っている可能性

---

### 3. リファクタリングの目的

> コードベース全体の可読性・保守性・拡張性を向上させ、将来の機能追加や不具合修正にかかる工数を削減する。

#### 観点別目的

* **型安全性**：バグの早期発見、補完性向上
* **責務分離**：UIの再利用性と見通しの良さを実現
* **テスト性**：品質と変更耐性の向上
* **構成明確化**：チーム内外でのスムーズな参照・修正
* **UI一貫性**：ユーザー体験と実装効率の向上
* **依存管理**：セキュリティとパフォーマンスの維持

---

### 4. 具体的なリファクタリング計画

#### 優先度：高

* tsconfig.jsonの`strict: true`化
* `any`削減と型定義の明示化
* `assistant.tsx`の分割と責務整理
* UI部品のprops型再設計
* ユニットテストとE2Eテストの拡充

#### 優先度：中

* ディレクトリ構成の再編（Atomic/Featureベース）
* スタイルの一貫性強化（共通化/デザインシステム）
* 不要パッケージ削除、依存のバージョン更新

---

### 5. Doneの定義（評価基準）

| カテゴリ    | Doneの定義                                            |
| ------- | -------------------------------------------------- |
| 型安全性    | `strict: true`で型エラーなし、`any`ゼロまたは理由付き明示             |
| コンポーネント | 各コンポーネントが100行未満、責務分離が明確、props型が明示                  |
| テスト     | カバレッジ50%以上、主要ロジックにユニット・E2Eテスト完備                    |
| 構成      | `components/`, `hooks/`などがAtomic/Feature単位で整理されている |
| スタイル    | 共通クラス・ユーティリティにまとめられ、スタイルガイド文書あり                    |
| 依存管理    | `yarn audit`で脆弱性なし、未使用依存ゼロ、主要ライブラリ最新               |

---

### 6. 次のアクション例

1. `tsconfig.json`の`strict: true`化と型エラー洗い出し
2. `assistant.tsx`の責務分離・分割案作成
3. coverage計測 → テスト対象リストアップ
4. `components/`, `hooks/`の構成整理案のドラフト作成
5. Tailwind共通ユーティリティ設計のたたき案作成
6. `package.json`から未使用依存の棚卸し

---

### 7. `assistant.tsx`の責務分離・分割案

#### 現状の主な責務
- チャットUIの表示（履歴・入力・送信ボタン等）
- メッセージ状態管理（useState, useEffect）
- API通信・認証・reCAPTCHA処理
- Sentry連携・エラーハンドリング
- 送信モード切替UI・ローカルストレージ管理
- サイドバーやレイアウトの組み立て

#### 分割方針（例）
1. **UI表示責務の分離**
   - `ChatMessages`: メッセージ履歴表示部分のコンポーネント化
   - `ChatInput`: 入力エリア・送信ボタン・送信モード切替UIの分離
2. **ロジック責務の分離**
   - `useChat`: メッセージ状態・API通信・認証・reCAPTCHA等のロジックをカスタムフック化
3. **エラーハンドリング・監視**
   - Sentry連携やErrorBoundaryはラッパーとして維持
4. **レイアウト・サイドバー**
   - レイアウト/サイドバーは親コンポーネントで管理

#### 分割実装タスク詳細

1. **UI表示責務の分離**
   - `ChatMessages.tsx`を新規作成し、メッセージ履歴表示部分（messagesのmap描画・ローディング表示含む）を切り出す。
   - `ChatInput.tsx`を新規作成し、入力エリア・送信ボタン・送信モード切替UIを切り出す。
   - それぞれprops型を明示し、100行未満を目安に責務を限定する。

2. **親コンポーネント（index.tsx）での統合**
   - `useChat`カスタムフック（状態・API通信・認証等）を作成し、親で呼び出し。
   - `ChatMessages`/`ChatInput`へ必要なprops（messages, loading, input, sendMode, 各種ハンドラ等）を渡す。
   - Sentry/ErrorBoundaryやSidebar等のレイアウト要素は親で管理。

3. **型定義・テスト**
   - `Message`型やprops型を`types.ts`等で共通化。
   - 各コンポーネント・フック単位でユニットテストを追加。

---

#### 参考：分割後の構成イメージ
```
src/app/assistant/
  ├─ index.tsx         // 親コンポーネント（レイアウト・責務分担）
  ├─ ChatMessages.tsx  // メッセージ履歴表示
  ├─ ChatInput.tsx     // 入力・送信UI
  ├─ useChat.ts        // チャットロジック（状態・API通信・認証等）
  └─ types.ts          // 型定義
```

---

#### 実装・レビュー観点
- 各コンポーネントの責務・props型が明確か
- 100行未満でシンプルに保たれているか
- UI/ロジックのテスト容易性が担保されているか
- 型安全性（strict: true）でエラーが出ないか
- 既存機能・UIの動作が維持されているか