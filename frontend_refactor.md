## GameChat AI フロントエンド・リファクタリング進捗管理

### 概要
- コードの可読性・保守性・拡張性向上を目的としたリファクタリング・テスト拡充プロジェクト
- 主要UI（AssistantPage/ChatMessages/ChatInput）・ロジック（useChat等）の型安全化・責務分離・テスト網羅

---

### 進捗まとめ（2025/07/06時点）

- ✅ useChatカスタムフック実装・ロジック分離
- ✅ assistant.tsxはuseChatフック利用の形にリファクタ済み
- ✅ UI表示責務はChatMessages/ChatInput等に分割
- ✅ 型定義・strict化・any排除
- ✅ AssistantPage/ChatMessages/ChatInputのユニットテスト全観点網羅・通過
- ✅ テスト観点・カバレッジレポートに基づきprops/UI/異常系も型安全に検証
- ✅ useChatの異常系もErrorBoundaryでカバー
- ⬆ coverageレポートでカバレッジ0%の業務ロジック・UI部品を優先してテスト追加中
- ✅ src/hooks/use-pwa.tsのユニットテスト作成・React 19対応済み
  - @testing-library/reactのrenderHookを利用し、環境依存の仕様も考慮したテストを追加

---

### 現状のコード構成
- `src/components/`：UI部品（Atomic Design粒度）
- `src/app/`：Next.js App Router構成
- `src/hooks/`：カスタムフック
- `src/lib/`：ユーティリティ・APIクライアント

---

### Doneの定義
| カテゴリ      | Doneの定義                                      |
| ------------ | ----------------------------------------------- |
| 型安全性      | strict: trueで型エラーなし、anyゼロ             |
| コンポーネント| 100行未満・責務分離・props型明示                |
| テスト        | カバレッジ50%以上・主要ロジック網羅             |
| 構成          | Atomic/Feature単位で整理                        |
| スタイル      | 共通クラス・スタイルガイドあり                  |
| 依存管理      | yarn auditで脆弱性なし・未使用依存ゼロ           |

---

### 優先タスク一覧（2025/07/06時点）

#### 【最優先】
1. カバレッジレポートの定期確認・未カバー領域の洗い出し
   - [ ] カバレッジ100%未満の箇所を抽出し、追加テストを検討
2. E2Eテスト・統合テストの拡充
   - [ ] Playwright等で主要ユーザーフローの自動化
   - [ ] エラー・例外・UI/UX観点のE2Eテスト追加
3. 型定義・型ガイドラインのドキュメント化
   - [ ] types.ts等の型定義共通化
   - [ ] 型ガイドライン・運用ルールの作成
4. CI/CDパイプラインでのテスト自動化・品質ゲート
   - [ ] PR時のテスト・カバレッジ・lint・型チェック自動化
   - [ ] カバレッジ閾値やlintエラーでfailする仕組み導入
5. 依存パッケージの棚卸し・セキュリティ監査
   - [ ] yarn audit/npm auditの定期実行と脆弱性対応
   - [ ] 未使用パッケージや重複依存の整理
6. ドキュメント・運用ルールの整備
   - [ ] テスト観点・運用ルール・開発フローをdocs/配下に記録
   - [ ] セットアップ手順やコントリビュートガイドの作成
7. パフォーマンス・アクセシビリティ改善
   - [ ] Lighthouse等で診断し、指摘事項を改善

---

### テスト観点・カバレッジ向上のための詳細
- APIルート：正常/異常/バリデーション/外部依存モック/型安全
- hooks：各種パターン網羅・返り値型・例外時
- UI部品：ローディング/props分岐/型安全
- ユーティリティ：境界値・例外・副作用・型安全

---

### テストカバレッジ方針
- **基本方針**：業務ロジック・UI部品・カスタムフック・APIルートなど、プロダクト品質やユーザー体験に直結する箇所はユニットテスト・結合テストで網羅する。
- **目標カバレッジ**：
  - 主要ロジック・UI部品・hooks・APIルートは80%以上のカバレッジを目指す
  - その他の補助的なユーティリティやラッパーも50%以上を目標
- **優先順位**：
  1. カバレッジ0%の業務ロジック・UI部品・hooks（例：src/components, src/hooks, src/app配下の主要ファイル）
  2. 既存テストがあるがカバレッジが低い箇所（20%以下など）
  3. 例外系・エラー処理・分岐ロジックも含めてテスト追加
- **E2Eテスト**：主要なユーザーフロー・異常系・アクセシビリティ観点もPlaywright等で自動化し、CIで常時検証
- **運用**：
  - カバレッジレポートを定期的に確認し、未カバー領域が発生した場合は優先的にテスト追加
  - カバレッジ閾値をCIで設定し、一定値未満の場合はPRをfailさせる

---

### 全体進捗・運用方針
- AssistantPage/ChatMessages/ChatInputのテストは全観点で完了
- coverageレポートでカバレッジ0%の業務ロジック・UI部品を優先してテスト追加中
- テスト観点・進捗・優先度は本ファイルで一元管理
- 進捗・観点の追加/修正は随時反映
- カバレッジ50%以上・主要ロジック網羅を目標

---

### 参考：今後のアクション例
- strict化・型エラー修正
- 構成整理・スタイル共通化・依存整理
- 型定義の共通化・型ガイドライン作成
- E2Eテスト拡充
- coverage計測・不足箇所の洗い出し
- テスト観点・カバレッジ結果をdocs/testing/等に記録

---

### 優先的にテスト追加すべきファイル一覧（2025/07/06追記）
- [x] `src/hooks/use-pwa.ts`  
  - 理由: 100行あるが 0%
  - テストで確認すべき内容例: `beforeinstallprompt` のハンドリング、状態変化 (`isSupported`, `isInstalled`)
- [x] `src/hooks/use-web-vitals.ts`  
  - 理由: 同上
  - テストで確認すべき内容例: `getCLS`, `getLCP` の記録を `mock` してコール確認、副作用（console.log, fetch）もspyで検証済み
  - 修正完了: `import.meta.env.MODE`のNext.jsビルドエラーを修正し、環境判定ロジックを安全に実装済み
- [x] `src/lib/firebase.ts`  
  - 理由: 非同期通信
  - テストで確認すべき内容例: `getAnalytics()` などの初期化モック、呼び出し確認
  - 実装完了: Firebase設定・初期化・Analytics関連のテストを追加。環境変数による初期化制御、エラー処理、Analytics初期化の動作確認済み
- [x] `src/lib/sentry.ts`  
  - 理由: エラーログ
  - テストで確認すべき内容例: `init`, `captureException` の `spyOn` モック確認
  - 実装完了: 全21テストケース追加。APIエラー報告、ユーザーアクション記録、パフォーマンス測定、エラー監視、メトリクス記録の動作確認済み。環境分岐・サーバーサイド処理・モック検証も網羅
- [ ] `src/components/ui/input.tsx`  
  - 理由: 状態変化
  - テストで確認すべき内容例: `onChange` や `value` の連携、ラベル描画確認など
- [ ] `src/components/error-boundary.tsx`  
  - 理由: Catch確認
  - テストで確認すべき内容例: 子がエラーを投げたとき、fallback UIに切り替わるか
- [ ] `src/components/app-sidebar.tsx`  
  - 理由: ロジック含む
  - テストで確認すべき内容例: 現在ページによる選択状態、ナビゲーション押下挙動