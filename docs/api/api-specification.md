# GameChat AI MVP API仕様

**最終更新**: 2025年10月10日

MVP版では `/chat` と `/health` の2エンドポイントのみを公開します。認証やreCAPTCHAは存在せず、フォールバック動作で最低限の応答を保証します。

---

## 公開エンドポイント

| Method | Path    | 説明                         |
|--------|---------|----------------------------|
| POST   | `/chat` | チャットメッセージを送信し、回答を取得 |
| GET    | `/health` | 稼働確認用のシンプルなヘルスチェック |

---

## POST `/chat`

### リクエストボディ

| フィールド       | 型     | 必須 | 説明 |
|------------------|--------|------|------|
| `message`        | string | Yes  | ユーザーからの質問。空文字の場合は簡易メッセージを返します。 |
| `top_k`          | int    | No   | 取得するカード候補数。省略時は5。実運用では1〜10を推奨。 |
| `with_context`   | bool   | No   | カード情報をレスポンスに含めるか。省略時は`true`。 |

### リクエスト例

```json
{
  "message": "雷属性のおすすめカードは？",
  "top_k": 5,
  "with_context": true
}
```

### レスポンス

| フィールド            | 型                  | 説明 |
|-----------------------|---------------------|------|
| `answer`              | string              | 生成された回答テキスト。フォールバック時は定型文。 |
| `retrieved_titles`    | string[]            | ベクトル検索で取得したカードタイトル。Upstash未設定時は空配列またはダミータイトル。 |
| `context`             | object[] &#124; null | `with_context=true` の場合にカード情報（タイトルや効果など）を返却。 |

#### レスポンス例（contextあり）

```json
{
  "answer": "雷属性のカードでは《ボルトドラゴン》が人気です。",
  "retrieved_titles": ["ボルトドラゴン", "ライトニングメイジ"],
  "context": [
    {
      "title": "ボルトドラゴン",
      "effect_1": "攻撃時に雷ダメージ+3",
      "rarity": "SR"
    }
  ]
}
```

#### レスポンス例（contextなし）

```json
{
  "answer": "雷属性のカードについて調査しましたが、詳細は取得できませんでした。",
  "retrieved_titles": []
}
```

### エラーモデル

- Pydantic のバリデーション失敗時は `422 Unprocessable Entity` が返されます。
- 実行時例外が発生した場合は `500 Internal Server Error`。フォールバックが成立すれば 200 を維持します。

### サーバー側のフォールバック

- **Embedding**: OpenAIキー未設定時は擬似ベクトルを生成します。
- **Vector検索**: Upstash未設定時はダミータイトルを返し、`context` を省略可能です。
- **LLM**: 生成に失敗した場合は固定メッセージで応答します。

---

## GET `/health`

ヘルスチェック用のシンプルなエンドポイントです。戻り値は `{ "status": "ok" }` を想定しています。

```bash
curl -s https://<cloud-run-url>/health
```

---

## 認証・CORS

- MVPでは認証やAPIキーは実装していません。
- Cloud Run 側の CORS 設定はワイルドカード（`*`）で運用し、必要に応じて後日制限します。

---

## 変更履歴
- 2025-10-10: MVP向けに `/chat` のみを掲載、reCAPTCHA/ハイブリッド検索に関する記述を削除。
