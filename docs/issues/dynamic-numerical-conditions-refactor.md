# Issue: 動的数値条件対応への改修

## 問題の概要

現在のbackendシステムを調査した結果、データベース検索において **明確なハードコーディングは確認されなかった** ものの、以下の課題が存在します：

1. **プロンプト・テスト・ドキュメントでの固定値使用**: 特定の数値条件（例：HP100以上、ダメージ40以上など）が多用されており、実際の使用例が限定的
2. **集約クエリ（最大値・最小値・一番高い等）への対応不足**: 現在の正規表現パターンでは「一番高い」「最大」「最小」などの集約条件を処理できない
3. **動的な数値範囲抽出の改善余地**: より柔軟な数値条件パターンへの対応

## 調査結果

### ✅ 現状で動的対応済みの部分

- **数値条件パーサー**: `database_service.py`では正規表現を使用して動的に数値条件を抽出
- **演算子サポート**: 「以上」「以下」「未満」「超」「等しい」の各演算子に対応
- **複数フィールド対応**: HP、攻撃力、ダメージ、コストの各フィールドで動的抽出

```python
# 現在の動的パーサー例
hp_match = re.search(r'HP(\d+)(以上|以下)|体力(\d+)(以上|以下)', query)
attack_match = re.search(r'攻撃(\d+)(以上|以下)|ダメージ(\d+)(以上|以上)', query)
```

### ❌ 改修が必要な部分

1. **集約クエリ対応の不足**
   - 「一番高い」「最大」「最小」「トップ」等の処理なし
   - ソート・集約機能の実装が必要

2. **プロンプト・テストでの固定値依存**
   - LLMプロンプトで特定数値の例示が固定化
   - テストケースで限定的な数値条件のみ使用

## 改修タスク

### Phase 1: 集約クエリ対応 【高優先度】

#### 1.1 集約クエリパターンの追加
```python
# 追加する正規表現パターン
AGGREGATION_PATTERNS = {
    'max': r'(一番高い|最大|最高|トップ)\s*(HP|ダメージ|攻撃力|コスト)',
    'min': r'(一番低い|最小|最低|ボトム)\s*(HP|ダメージ|攻撃力|コスト)',
    'top_n': r'(上位|トップ)(\d+)\s*(HP|ダメージ|攻撃力|コスト)'
}
```

#### 1.2 集約処理ロジックの実装
- ソート機能の追加
- 上位N件・下位N件の抽出
- 最大値・最小値の特定

### Phase 2: 動的数値範囲の強化 【中優先度】

#### 2.1 より複雑な数値パターンへの対応
```python
# 拡張する数値パターン
COMPLEX_PATTERNS = {
    'range': r'(\d+)から(\d+)の間',
    'multiple': r'(\d+)または(\d+)',
    'approximate': r'約(\d+)|(\d+)程度'
}
```

#### 2.2 フィールドマッピングの改善
- より多様なフィールド名パターンへの対応
- 日本語・英語の混在パターンの処理

### Phase 3: プロンプト・テストの改善 【低優先度】

#### 3.1 LLMプロンプトの多様化
- 固定値例示の削除
- より多様な数値条件例の追加

#### 3.2 テストケースの拡充
- ランダム数値でのテスト追加
- 集約クエリのテストケース追加

## 実装スケジュール

| タスク | 工数見積もり | 優先度 | 担当者 |
|--------|-------------|--------|--------|
| 集約クエリパターン追加 | 2-3時間 | 高 | - |
| 集約処理ロジック実装 | 4-6時間 | 高 | - |
| 複雑数値パターン対応 | 3-4時間 | 中 | - |
| プロンプト改善 | 1-2時間 | 低 | - |
| テストケース拡充 | 2-3時間 | 低 | - |

**合計工数**: 12-18時間

## 影響範囲

### 変更対象ファイル
- `backend/app/services/database_service.py` (メイン)
- `backend/app/services/classification_service.py` (プロンプト改善)
- `backend/app/tests/services/test_database_service.py` (テスト追加)

### 互換性への影響
- **既存機能への影響**: 無し（拡張のみ）
- **API変更**: 無し
- **フロントエンドへの影響**: 無し

## 実装タスクリスト

### Phase 1: 集約クエリ対応 【高優先度】

#### 1.1 集約クエリパターンの実装
- [x] `database_service.py`に集約クエリ用正規表現パターンを追加
  - [x] 最大値パターン (`一番高い|最大|最高|トップ`)
  - [x] 最小値パターン (`一番低い|最小|最低|ボトム`)
  - [x] 上位N件パターン (`上位|トップ\d+`)
- [x] 集約クエリ検出メソッド `_detect_aggregation_query()` の実装
- [x] 集約クエリパーサー `_parse_aggregation_condition()` の実装

#### 1.2 集約処理ロジックの実装
- [x] ソート機能 `_sort_by_field()` メソッドの追加
- [x] 最大値取得 `_get_max_value_items()` メソッドの実装
- [x] 最小値取得 `_get_min_value_items()` メソッドの実装
- [x] 上位N件取得 `_get_top_n_items()` メソッドの実装
- [x] フィールド値抽出ヘルパー `_extract_numeric_field()` の実装

#### 1.3 既存メソッドとの統合
- [x] `filter_search_llm_async()` に集約クエリ処理を統合
- [x] `_match_filterable_llm()` で集約条件のスキップ処理を追加
- [x] エラーハンドリング（数値フィールドが存在しない場合）の実装

### Phase 2: 動的数値範囲の強化 【中優先度】

#### 2.1 複雑な数値パターンの対応
- [x] 範囲指定パターン (`\d+から\d+の間`) の追加
- [x] 複数値パターン (`\d+または\d+`) の追加
- [x] 近似値パターン (`約\d+|\d+程度`) の追加
- [x] `_parse_complex_numeric_conditions()` メソッドの実装

#### 2.2 フィールドマッピングの改善
- [x] より多様なフィールド名パターンの辞書作成
- [x] 日本語・英語混在パターンの正規化処理
- [x] フィールド名の曖昧性解決ロジックの実装

### Phase 3: プロンプト・テストの改善 【低優先度】

#### 3.1 LLMプロンプトの改善
- [ ] `classification_service.py`のシステムプロンプト更新
  - [ ] 固定数値例示の削除
  - [ ] 集約クエリ例の追加
  - [ ] より多様な数値条件例の追加
- [ ] 分類精度向上のためのプロンプト調整

#### 3.2 テストケースの拡充
- [ ] 集約クエリのテストケース追加
  - [ ] 最大値/最小値検索のテスト
  - [ ] 上位N件検索のテスト
  - [ ] 複合条件（集約+フィルター）のテスト
- [x] 複雑数値パターンのテストケース追加
- [x] ランダム数値でのテスト追加
- [x] エラーケースのテスト追加

### Phase 4: 品質向上・最適化 【低優先度】

#### 4.1 パフォーマンス最適化
- [ ] 集約処理のキャッシュ機能追加
- [ ] 大量データでのソート性能検証
- [ ] メモリ使用量の最適化

#### 4.2 ログ・監視の改善
- [ ] 集約クエリ実行ログの追加
- [ ] パフォーマンスメトリクスの記録
- [ ] エラー詳細ログの改善

#### 4.3 ドキュメント更新
- [ ] API仕様書に集約クエリ機能を追記
- [ ] ハイブリッド検索ガイドの更新
- [ ] サンプルクエリ集の作成

## 成功指標

### 機能面
- [x] 「一番高いHP」「最大ダメージ」等の集約クエリが正常動作
- [x] 従来の数値条件（「100以上」等）が引き続き動作
- [x] より複雑な数値範囲（「50から100の間」等）に対応

### パフォーマンス面
- [ ] 検索レスポンス時間の劣化なし（現在値±10%以内）
- [ ] メモリ使用量の大幅な増加なし

### 品質面
- [ ] テストカバレッジ90%以上維持
- [ ] 既存テストケースの全通過

## 備考

- 現在のシステムは既に十分に動的な数値条件処理を実装済み
- 主な改修は「集約クエリ」への対応となる
- ハードコーディングされた固定値の削除は必要性が低い
- ユーザビリティ向上のための機能拡張として位置づけ

## 関連ドキュメント

- [ハイブリッド検索システム実装ガイド](../guides/hybrid_search_guide.md)
- [データベースサービス仕様](../sphinx_docs/services/database_service.rst)
- [検索システムAPI仕様](../api/search_api.md)
