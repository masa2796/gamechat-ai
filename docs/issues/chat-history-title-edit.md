# Issue: チャット履歴に題名（タイトル）を追加・編集する機能

## 目的

# 機能改善提案: チャット履歴タイトル編集

> **ARCHIVE_CANDIDATE**: チャット履歴機能はMVP対象外のため、この改善提案も後続フェーズで検討します。
- 現状のチャット履歴管理ではセッション自体は存在するが、タイトルの運用が不十分（空/固定/編集不可など）。

## スコープ
- フロントエンド（Next.js）でのタイトル表示/編集/保存機能。
- LocalStorage（または既存クライアント永続化）への反映。
- 既存履歴のマイグレーション（無題セッションへの既定タイトル付与）。
- バックエンドAPI変更は不要（本Issueでは対象外）。

## 成功基準（Acceptance Criteria）
- サイドバーで各セッションのタイトルが表示される（省略表示はUIのみ、保存値はフル文字列）。
- 以下の編集手段のいずれかでタイトルを変更できる：
  - タイトル行のペン（編集）アイコンをクリック
  - タイトルをダブルクリック
  - キーボード: F2 で編集開始、Enter で確定、Esc でキャンセル
- 初回メッセージ送信時に自動タイトルが生成される（先頭ユーザーメッセージから要約/トリム）。
- タイトル変更は即時保存され、リロード後も保持される（LocalStorage）。
- タイトル更新時に `updatedAt` が更新され、ソートや表示に反映される。
- 空白のみ/長すぎる入力はバリデーションされる（空は拒否、UIはエラーメッセージ表示）。
- 既存の単体/統合/E2Eテストがパスし、本機能のテストも追加で合格する。

## 要件（機能仕様）
- 入力: ユーザーのタイトル文字列（UTF-8、日本語/英数字/絵文字許容）。
- 出力: セッションの `title` を更新し、状態・ストレージに永続化。
- バリデーション:
  - 最小長: 1（空白トリム後）
  - 最大長: 80（保存値）。UI表示は 32 文字で省略（…）。
  - 制御文字・改行は除去。XSS対策でHTMLエスケープ表示。
- 自動生成規則（初期案）:
  - 先頭のユーザーメッセージから句読点/助詞を軽く正規化した先頭32文字。
  - メッセージがない場合は「新規チャット」。
- 競合/重複: タイトルの一意性は求めない（重複可）。
- アクセシビリティ: 編集フィールドに適切なラベル（aria-label）、フォーカスリング、キーボード操作対応。

## 非機能要件
- パフォーマンス: 編集操作は同期で完了（<10ms目安）。ストレージ書込はデバウンス（300ms）推奨。
- 安定性: 失敗時は前回保存値にフォールバックし、通知を表示。
- 監査性: 変更イベントを開発ログに記録（devモード）。

## データモデル/保存仕様
```ts
// 既存想定（docs/issues/chat-history.md より）
export interface ChatSession {
  id: string
  title: string // 本Issueで編集/生成の対象
  messages: Message[]
  createdAt: Date
  updatedAt: Date
  isActive: boolean
}

export interface ChatHistoryState {
  sessions: ChatSession[]
  activeSessionId: string | null
  maxSessions: number
}
```

- ストレージキー: 既存の `chat-sessions`/`active-session-id` を継続利用。
- マイグレーション: ロード時、`title` が空/未定義のセッションに `autoTitle(session)` を適用。

## UI/UX 仕様
- サイドバー項目
  - 通常時: タイトル（省略表示）＋最終更新相対時刻
  - ホバー時: 編集（ペン）アイコン表示
  - 編集時: テキストフィールドに切替、Enter/Blurで保存、Escでキャンセル
- チャットヘッダー
  - タイトル表示の右に編集アイコンを配置（任意）。
- 空タイトルエラー
  - トースト or インラインエラー（「タイトルを入力してください」）
- i18n
  - ユーザー向け表示文言は日本語。必要なら英語メッセージも追加可能。

## API/バックエンド
- 本Issueでは変更なし。フロント内でローカル永続化。

## 実装タスク

### Phase 1: 基盤
- [ ] `useChatHistory.ts` に `updateSessionTitle(sessionId: string, title: string)` を追加
- [ ] タイトル自動生成 `autoTitle(messages?: Message[])` のユーティリティ作成
- [ ] 初回メッセージ送信時に `autoTitle` を適用（既にタイトルがデフォルト/空のとき）
- [ ] LocalStorage 同期（デバウンス保存、`updatedAt` 更新）

### Phase 2: UI
- [ ] `app-sidebar.tsx` にインライン編集UIを実装（アイコン/ダブルクリック/F2対応）
- [ ] 編集時のフォーカス管理とアクセシビリティ（aria属性）
- [ ] タイトル表示の省略・ツールチップ（フル表示）

### Phase 3: マイグレーション/互換
- [ ] ロード時に無題セッションへ自動タイトル付与
- [ ] 旧データ形式の検出と安全な更新（必要に応じてバージョンフラグ）

### Phase 4: テスト
- [ ] ユニット: `updateSessionTitle`、`autoTitle` のバリデーションと境界値
- [ ] 統合: 送信→自動タイトル生成→手動編集の一連の流れ
- [ ] E2E（Playwright）: ダブルクリック編集→Enter確定→リロード後保持

## 変更ファイル（想定）
- `frontend/src/hooks/useChatHistory.ts`（新規関数/保存処理）
- `frontend/src/app/assistant/useChat.ts`（初回メッセージ時の自動タイトル）
- `frontend/src/components/app-sidebar.tsx`（インライン編集UI）
- `frontend/src/types/chat.ts`（必要なら型の微調整）

## リスクと対策
- XSS/スクリプト挿入: 表示時はエスケープ、危険文字を保存前に正規化。
- 競合更新: 同時編集は想定外（シングルクライアント前提）。
- 長大タイトル: 保存は80字まで、UIは省略。ツールチップで全体確認。

## 計測/ログ（任意）
- 変更回数、タイトル平均長、取り消し率などをDevログに記録。

## 完了の定義（DoD）
- すべてのAcceptance Criteriaを満たす。
- 既存テスト＋追加テストがCIでグリーン。
- ドキュメント（このIssue、簡易ガイド）を更新。

## スケジュール（目安）
- 実装/レビュー: 0.5〜1.5日
- テスト/E2E整備: 0.5日
- 合計: 1〜2日

## 関連
- `docs/issues/chat-history.md`（履歴管理の全体計画と既知課題）
