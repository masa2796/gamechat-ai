name: Automatic Rollback System

on:
  workflow_dispatch:
    inputs:
      rollback_reason:
        description: 'Rollback Reason'
        required: true
        type: choice
        options:
          - high-error-rate
          - performance-degradation
          - manual-rollback
          - security-incident
      target_version:
        description: 'Target Version (leave empty for previous)'
        required: false
        type: string
      immediate_rollback:
        description: 'Immediate Rollback (skip approval)'
        required: false
        default: false
        type: boolean

  # è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼ï¼ˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®Webhookï¼‰
  repository_dispatch:
    types: [auto-rollback]

env:
  PROJECT_ID: gamechat-ai
  REGION: asia-northeast1
  SERVICE_NAME: gamechat-ai-backend

jobs:
  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯äº‹å‰ãƒã‚§ãƒƒã‚¯
  pre-rollback-check:
    name: Pre-Rollback Validation
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.current.outputs.version }}
      target-version: ${{ steps.target.outputs.version }}
      rollback-safe: ${{ steps.validation.outputs.safe }}
      
    steps:
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Get Current Deployment Info
      id: current
      run: |
        # ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        CURRENT_VERSION=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(metadata.labels.version)")
        CURRENT_IMAGE=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(spec.template.spec.template.spec.containers[0].image)")
        
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "image=$CURRENT_IMAGE" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Current Version: $CURRENT_VERSION"
        echo "ğŸ–¼ï¸ Current Image: $CURRENT_IMAGE"
        
    - name: Determine Target Version
      id: target
      run: |
        TARGET_VERSION="${{ github.event.inputs.target_version }}"
        
        if [ -z "$TARGET_VERSION" ]; then
          # å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          PREVIOUS_VERSIONS=$(gcloud run revisions list --service=${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(metadata.name)" --sort-by="~metadata.creationTimestamp" --limit=5)
          TARGET_VERSION=$(echo "$PREVIOUS_VERSIONS" | sed -n '2p')
        fi
        
        if [ -z "$TARGET_VERSION" ]; then
          echo "âŒ No target version found for rollback"
          exit 1
        fi
        
        echo "version=$TARGET_VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Target Version: $TARGET_VERSION"
        
    - name: Validate Rollback Safety
      id: validation
      run: |
        TARGET_VERSION="${{ steps.target.outputs.version }}"
        CURRENT_VERSION="${{ steps.current.outputs.version }}"
        
        echo "ğŸ” Validating rollback safety..."
        
        # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
        if ! gcloud run revisions describe "$TARGET_VERSION" --region=${{ env.REGION }} > /dev/null 2>&1; then
          echo "âŒ Target version $TARGET_VERSION not found"
          echo "safe=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ˜ãƒ«ã‚¹çŠ¶æ…‹ç¢ºèª
        TARGET_IMAGE=$(gcloud run revisions describe "$TARGET_VERSION" --region=${{ env.REGION }} --format="value(spec.template.spec.containers[0].image)")
        
        echo "âœ… Target version validation passed"
        echo "safe=true" >> $GITHUB_OUTPUT
        echo "ğŸ–¼ï¸ Target Image: $TARGET_IMAGE"

  # ç·Šæ€¥åº¦åˆ¤å®š
  assess-urgency:
    name: Assess Rollback Urgency
    runs-on: ubuntu-latest
    needs: pre-rollback-check
    outputs:
      urgency-level: ${{ steps.assess.outputs.urgency }}
      skip-approval: ${{ steps.assess.outputs.skip-approval }}
      
    steps:
    - name: Assess Urgency Level
      id: assess
      run: |
        REASON="${{ github.event.inputs.rollback_reason || github.event.client_payload.reason }}"
        IMMEDIATE="${{ github.event.inputs.immediate_rollback }}"
        
        echo "ğŸ“ˆ Assessing rollback urgency..."
        echo "Reason: $REASON"
        
        case "$REASON" in
          "high-error-rate")
            URGENCY="high"
            SKIP_APPROVAL="true"
            ;;
          "security-incident")
            URGENCY="critical"
            SKIP_APPROVAL="true"
            ;;
          "performance-degradation")
            URGENCY="medium"
            SKIP_APPROVAL="false"
            ;;
          "manual-rollback")
            URGENCY="low"
            SKIP_APPROVAL="false"
            ;;
          *)
            URGENCY="medium"
            SKIP_APPROVAL="false"
            ;;
        esac
        
        if [ "$IMMEDIATE" = "true" ]; then
          SKIP_APPROVAL="true"
        fi
        
        echo "urgency=$URGENCY" >> $GITHUB_OUTPUT
        echo "skip-approval=$SKIP_APPROVAL" >> $GITHUB_OUTPUT
        
        echo "ğŸš¨ Urgency Level: $URGENCY"
        echo "â­ï¸ Skip Approval: $SKIP_APPROVAL"

  # æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ï¼ˆç·Šæ€¥æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  rollback-approval:
    name: Rollback Approval
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, assess-urgency]
    if: needs.assess-urgency.outputs.skip-approval == 'false'
    environment: 
      name: rollback-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
    steps:
    - name: Request Rollback Approval
      run: |
        echo "ğŸ” Rollback approval required"
        echo ""
        echo "ğŸ“Š Rollback Details:"
        echo "- Current Version: ${{ needs.pre-rollback-check.outputs.current-version }}"
        echo "- Target Version: ${{ needs.pre-rollback-check.outputs.target-version }}"
        echo "- Reason: ${{ github.event.inputs.rollback_reason }}"
        echo "- Urgency: ${{ needs.assess-urgency.outputs.urgency-level }}"
        echo ""
        echo "âš ï¸ Please review the following before approval:"
        echo "- Current system metrics and error rates"
        echo "- Impact of rolling back to target version"
        echo "- Alternative mitigation strategies"
        echo "- Communication plan for users"

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  backup-current-state:
    name: Backup Current State
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, assess-urgency]
    if: needs.assess-urgency.outputs.urgency-level != 'critical'
    
    steps:
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Create Configuration Backup
      run: |
        BACKUP_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BACKUP_NAME="rollback-backup-$BACKUP_TIMESTAMP"
        
        echo "ğŸ’¾ Creating configuration backup: $BACKUP_NAME"
        
        # ç¾åœ¨ã®ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --format="export" > "service-config-$BACKUP_NAME.yaml"
          
        # Cloud Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        # gsutil cp "service-config-$BACKUP_NAME.yaml" gs://your-backup-bucket/rollbacks/
        
        echo "âœ… Configuration backup completed"
        
    - name: Upload Backup Artifact
      uses: actions/upload-artifact@v3
      with:
        name: rollback-backup
        path: service-config-*.yaml
        retention-days: 90

  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
  execute-rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, assess-urgency, backup-current-state]
    if: |
      always() && 
      needs.pre-rollback-check.outputs.rollback-safe == 'true' && 
      (needs.assess-urgency.outputs.skip-approval == 'true' || 
       needs.rollback-approval.result == 'success')
    
    steps:
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Execute Traffic Rollback
      run: |
        TARGET_VERSION="${{ needs.pre-rollback-check.outputs.target-version }}"
        URGENCY="${{ needs.assess-urgency.outputs.urgency-level }}"
        
        echo "ğŸ”„ Starting rollback to version: $TARGET_VERSION"
        echo "ğŸš¨ Urgency level: $URGENCY"
        
        if [ "$URGENCY" = "critical" ]; then
          # ç·Šæ€¥æ™‚ï¼šå³åº§ã«100%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆ
          echo "ğŸš¨ CRITICAL: Immediate 100% traffic rollback"
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --to-revisions="$TARGET_VERSION=100" \
            --platform managed
        else
          # æ®µéšçš„ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
          echo "ğŸ“ˆ Gradual rollback process"
          
          # Step 1: 50% traffic to target version
          echo "Step 1: 50% traffic to target version"
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --to-revisions="$TARGET_VERSION=50,${{ needs.pre-rollback-check.outputs.current-version }}=50" \
            --platform managed
          
          sleep 30
          
          # Step 2: 100% traffic to target version
          echo "Step 2: 100% traffic to target version"
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --to-revisions="$TARGET_VERSION=100" \
            --platform managed
        fi
        
        echo "âœ… Traffic rollback completed"
        
    - name: Update Service Labels
      run: |
        TARGET_VERSION="${{ needs.pre-rollback-check.outputs.target-version }}"
        ROLLBACK_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        REASON="${{ github.event.inputs.rollback_reason || github.event.client_payload.reason }}"
        
        # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æƒ…å ±ã‚’ãƒ©ãƒ™ãƒ«ã«è¨˜éŒ²
        gcloud run services update ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --update-labels="last-rollback=$ROLLBACK_TIMESTAMP,rollback-reason=$REASON,rolled-back-to=$TARGET_VERSION"
          
        echo "ğŸ·ï¸ Service labels updated with rollback information"

  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®æ¤œè¨¼
  post-rollback-validation:
    name: Post-Rollback Validation
    runs-on: ubuntu-latest
    needs: execute-rollback
    
    steps:
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Health Check After Rollback
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)")
        
        echo "ğŸ” Post-rollback health check"
        echo "Service URL: $SERVICE_URL"
        
        # è¤‡æ•°å›ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        SUCCESS_COUNT=0
        for i in {1..10}; do
          echo "Health check attempt $i/10"
          
          if curl -f --max-time 30 "$SERVICE_URL/health" > /dev/null 2>&1; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "âœ… Attempt $i: Success"
          else
            echo "âŒ Attempt $i: Failed"
          fi
          
          sleep 10
        done
        
        SUCCESS_RATE=$((SUCCESS_COUNT * 10))
        echo "ğŸ“Š Success rate: $SUCCESS_RATE%"
        
        if [ $SUCCESS_COUNT -ge 8 ]; then
          echo "âœ… Post-rollback health check passed"
        else
          echo "âŒ Post-rollback health check failed"
          exit 1
        fi
        
    - name: Performance Validation
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)")
        
        echo "ğŸš€ Performance validation after rollback"
        
        TOTAL_TIME=0
        SAMPLE_COUNT=5
        
        for i in $(seq 1 $SAMPLE_COUNT); do
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "$SERVICE_URL/health")
          echo "Response time $i: ${RESPONSE_TIME}s"
          TOTAL_TIME=$(echo "$TOTAL_TIME + $RESPONSE_TIME" | bc)
        done
        
        AVG_TIME=$(echo "scale=3; $TOTAL_TIME / $SAMPLE_COUNT" | bc)
        echo "ğŸ“Š Average response time: ${AVG_TIME}s"
        
        if (( $(echo "$AVG_TIME < 5.0" | bc -l) )); then
          echo "âœ… Performance validation passed"
        else
          echo "âš ï¸ Performance validation warning: Slow response time"
        fi

  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®ç›£è¦–
  post-rollback-monitoring:
    name: Post-Rollback Monitoring
    runs-on: ubuntu-latest
    needs: post-rollback-validation
    
    steps:
    - name: Setup Monitoring
      run: |
        echo "ğŸ“Š Setting up enhanced monitoring after rollback"
        
        # 30åˆ†é–“ã®é›†ä¸­ç›£è¦–
        for i in {1..6}; do
          echo "Monitoring cycle $i/6 (5 minutes each)"
          
          # ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹ç¢ºèª
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)")
          
          if curl -f --max-time 30 "$SERVICE_URL/health" > /dev/null 2>&1; then
            echo "âœ… Cycle $i: Service healthy"
          else
            echo "âŒ Cycle $i: Service unhealthy"
            # ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ï¼ˆå®Ÿè£…å¿…è¦ï¼‰
          fi
          
          # 5åˆ†å¾…æ©Ÿï¼ˆæœ€å¾Œã®å¾ªç’°ä»¥å¤–ï¼‰
          if [ $i -lt 6 ]; then
            sleep 300
          fi
        done
        
        echo "âœ… 30-minute monitoring completed"

  # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  generate-rollback-report:
    name: Generate Rollback Report
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, assess-urgency, execute-rollback, post-rollback-validation]
    if: always()
    
    steps:
    - name: Generate Report
      run: |
        ROLLBACK_TIMESTAMP=$(date)
        STATUS="${{ needs.post-rollback-validation.result }}"
        
        cat > rollback-report.md << EOF
        # ğŸ”„ Automatic Rollback Report
        
        **Date**: $ROLLBACK_TIMESTAMP
        **Status**: $([ "$STATUS" = "success" ] && echo "âœ… SUCCESS" || echo "âŒ FAILED")
        
        ## Rollback Summary
        - **Reason**: ${{ github.event.inputs.rollback_reason || github.event.client_payload.reason }}
        - **Urgency**: ${{ needs.assess-urgency.outputs.urgency-level }}
        - **Previous Version**: ${{ needs.pre-rollback-check.outputs.current-version }}
        - **Rolled Back To**: ${{ needs.pre-rollback-check.outputs.target-version }}
        
        ## Process Timeline
        - â° Rollback initiated: $ROLLBACK_TIMESTAMP
        - ğŸ” Pre-rollback validation: ${{ needs.pre-rollback-check.result }}
        - ğŸš¨ Urgency assessment: ${{ needs.assess-urgency.result }}
        - ğŸ”„ Rollback execution: ${{ needs.execute-rollback.result }}
        - âœ… Post-rollback validation: ${{ needs.post-rollback-validation.result }}
        
        ## Validation Results
        $([ "$STATUS" = "success" ] && echo "- âœ… Health checks passed" || echo "- âŒ Health checks failed")
        $([ "$STATUS" = "success" ] && echo "- âœ… Performance validation passed" || echo "- âŒ Performance validation failed")
        
        ## Next Steps
        - Continue monitoring for next 24 hours
        - Investigate root cause of issues that triggered rollback
        - Plan forward fix if applicable
        - Update incident documentation
        
        ## Service Information
        - **Service URL**: $(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)" 2>/dev/null || echo "Unable to retrieve")
        - **Current Status**: $(curl -s "$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)" 2>/dev/null)/health" | jq -r '.status // "unknown"' 2>/dev/null || echo "Unable to check")
        EOF
        
        echo "ğŸ“‹ Rollback report generated"
        cat rollback-report.md
        
    - name: Upload Rollback Report
      uses: actions/upload-artifact@v3
      with:
        name: rollback-report
        path: rollback-report.md
        retention-days: 365

  # é€šçŸ¥
  notify-rollback-status:
    name: Notify Rollback Status
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, post-rollback-validation, generate-rollback-report]
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.post-rollback-validation.result == 'success'
      run: |
        echo "âœ… Automatic rollback completed successfully!"
        echo "ğŸ”„ Rolled back to: ${{ needs.pre-rollback-check.outputs.target-version }}"
        echo "ğŸ“Š System status: Stable"
        
        # Slack/Discord/ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’è¿½åŠ 
        
    - name: Notify Failure
      if: needs.post-rollback-validation.result == 'failure'
      run: |
        echo "âŒ Automatic rollback failed!"
        echo "ğŸš¨ URGENT: Manual intervention required"
        echo "ğŸ“ Contact: DevOps team immediately"
        
        # ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ã‚’è¿½åŠ 
