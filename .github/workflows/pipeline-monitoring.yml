name: Pipeline Monitoring and Reporting

on:
  schedule:
    - cron: '0 8 * * MON'  # æ¯é€±æœˆæ›œæ—¥ 8:00 (JST 17:00)
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy to Production", "Blue-Green Deployment", "Automatic Rollback"]
    types: [completed]

jobs:
  # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±è¨ˆåé›†
  collect-pipeline-metrics:
    name: Collect Pipeline Metrics
    runs-on: ubuntu-latest
    outputs:
      metrics-data: ${{ steps.metrics.outputs.data }}
      
    steps:
    - name: Collect Deployment Metrics
      id: metrics
      run: |
        echo "ğŸ“Š Collecting pipeline metrics from the last 7 days..."
        
        # GitHub API ã§éå»7æ—¥é–“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’å–å¾—
        WEEK_AGO=$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%SZ)
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸç‡
        DEPLOY_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/runs?created=>$WEEK_AGO&per_page=100" | \
          jq '.workflow_runs | length')
          
        DEPLOY_SUCCESS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/runs?created=>$WEEK_AGO&status=success&per_page=100" | \
          jq '.workflow_runs | length')
        
        # ãƒ†ã‚¹ãƒˆæˆåŠŸç‡
        TEST_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/comprehensive-testing.yml/runs?created=>$WEEK_AGO&per_page=100" | \
          jq '.workflow_runs | length')
          
        TEST_SUCCESS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/comprehensive-testing.yml/runs?created=>$WEEK_AGO&status=success&per_page=100" | \
          jq '.workflow_runs | length')
        
        # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å›æ•°
        ROLLBACK_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/automatic-rollback.yml/runs?created=>$WEEK_AGO&per_page=100" | \
          jq '.workflow_runs | length')
        
        # æˆåŠŸç‡è¨ˆç®—
        DEPLOY_SUCCESS_RATE=$([ $DEPLOY_RUNS -gt 0 ] && echo "scale=2; $DEPLOY_SUCCESS * 100 / $DEPLOY_RUNS" | bc || echo "0")
        TEST_SUCCESS_RATE=$([ $TEST_RUNS -gt 0 ] && echo "scale=2; $TEST_SUCCESS * 100 / $TEST_RUNS" | bc || echo "0")
        
        # å¹³å‡ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“è¨ˆç®—ï¼ˆç°¡ç•¥åŒ–ï¼‰
        AVG_DEPLOY_TIME="15"  # å®Ÿéš›ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã«ç½®ãæ›ãˆ
        
        # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        METRICS_JSON=$(cat << EOF
        {
          "period": "7_days",
          "deployments": {
            "total": $DEPLOY_RUNS,
            "successful": $DEPLOY_SUCCESS,
            "success_rate": $DEPLOY_SUCCESS_RATE,
            "avg_duration_minutes": $AVG_DEPLOY_TIME
          },
          "tests": {
            "total": $TEST_RUNS,
            "successful": $TEST_SUCCESS,
            "success_rate": $TEST_SUCCESS_RATE
          },
          "rollbacks": {
            "total": $ROLLBACK_RUNS
          },
          "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        )
        
        echo "data=$METRICS_JSON" >> $GITHUB_OUTPUT
        
        echo "ğŸ“ˆ Metrics Summary:"
        echo "  Deployments: $DEPLOY_SUCCESS/$DEPLOY_RUNS (${DEPLOY_SUCCESS_RATE}%)"
        echo "  Tests: $TEST_SUCCESS/$TEST_RUNS (${TEST_SUCCESS_RATE}%)"
        echo "  Rollbacks: $ROLLBACK_RUNS"

  # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æ
  analyze-test-coverage:
    name: Analyze Test Coverage
    runs-on: ubuntu-latest
    outputs:
      coverage-report: ${{ steps.coverage.outputs.report }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        cache: 'pip'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: Analyze Backend Coverage
      id: backend-coverage
      run: |
        pip install -r requirements.txt
        pip install pytest-cov
        
        cd backend
        export TESTING=true
        
        # ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬
        python -m pytest app/tests/ \
          --cov=app \
          --cov-report=json:coverage.json \
          --cov-report=term
          
        BACKEND_COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(f'{data[\"totals\"][\"percent_covered\"]:.1f}')")
        
        echo "backend-coverage=$BACKEND_COVERAGE" >> $GITHUB_OUTPUT
        echo "ğŸ Backend Coverage: ${BACKEND_COVERAGE}%"
        
    - name: Analyze Frontend Coverage
      id: frontend-coverage
      run: |
        echo "Checking frontend directory..."
        if [ -d "frontend" ]; then
          cd frontend
          npm ci --prefer-offline --no-audit
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬
          npm test -- --coverage --watchAll=false --silent || true
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
          if [ -f "coverage/coverage-summary.json" ]; then
            FRONTEND_COVERAGE=$(grep -o '"pct":[0-9.]*' coverage/coverage-summary.json | head -1 | cut -d: -f2)
          else
            echo "âš ï¸ Coverage file not found, using default value"
            FRONTEND_COVERAGE="0"
          fi
          
          echo "frontend-coverage=$FRONTEND_COVERAGE" >> $GITHUB_OUTPUT
          echo "âš›ï¸ Frontend Coverage: ${FRONTEND_COVERAGE}%"
        else
          echo "âš ï¸ Frontend directory not found, setting coverage to 0"
          echo "frontend-coverage=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate Coverage Report
      id: coverage
      run: |
        BACKEND_COV="${{ steps.backend-coverage.outputs.backend-coverage }}"
        FRONTEND_COV="${{ steps.frontend-coverage.outputs.frontend-coverage }}"
        OVERALL_COV=$(echo "scale=1; ($BACKEND_COV + $FRONTEND_COV) / 2" | bc)
        
        COVERAGE_JSON=$(cat << EOF
        {
          "overall": $OVERALL_COV,
          "backend": $BACKEND_COV,
          "frontend": $FRONTEND_COV,
          "targets": {
            "backend": 85,
            "frontend": 80,
            "overall": 82.5
          },
          "status": {
            "backend": $([ $(echo "$BACKEND_COV >= 85" | bc) -eq 1 ] && echo "\"âœ… Pass\"" || echo "\"âŒ Below Target\""),
            "frontend": $([ $(echo "$FRONTEND_COV >= 80" | bc) -eq 1 ] && echo "\"âœ… Pass\"" || echo "\"âŒ Below Target\""),
            "overall": $([ $(echo "$OVERALL_COV >= 82.5" | bc) -eq 1 ] && echo "\"âœ… Pass\"" || echo "\"âŒ Below Target\"")
          }
        }
        EOF
        )
        
        echo "report=$COVERAGE_JSON" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Overall Coverage: ${OVERALL_COV}%"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµ±è¨ˆ
  security-scan-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    outputs:
      security-report: ${{ steps.security.outputs.report }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Dependency Scan
      run: |
        echo "ğŸ”’ Running dependency vulnerability scan..."
        
        # Python dependencies
        pip install safety
        PYTHON_VULNS=$(safety check -r requirements.txt --json | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
        
        # Node.js dependencies
        cd frontend
        npm audit --json > audit-results.json || true
        NODE_VULNS=$(jq '.metadata.vulnerabilities.total' audit-results.json 2>/dev/null || echo "0")
        cd ..
        
        echo "ğŸ Python vulnerabilities: $PYTHON_VULNS"
        echo "âš›ï¸ Node.js vulnerabilities: $NODE_VULNS"
        
        echo "python-vulns=$PYTHON_VULNS" >> $GITHUB_OUTPUT
        echo "node-vulns=$NODE_VULNS" >> $GITHUB_OUTPUT
        
    - name: Generate Security Report
      id: security
      run: |
        SECURITY_JSON=$(cat << EOF
        {
          "dependencies": {
            "python_vulnerabilities": ${{ steps.security-scan-summary.outputs.python-vulns || 0 }},
            "nodejs_vulnerabilities": ${{ steps.security-scan-summary.outputs.node-vulns || 0 }}
          },
          "overall_status": $([ $((${{ steps.security-scan-summary.outputs.python-vulns || 0 }} + ${{ steps.security-scan-summary.outputs.node-vulns || 0 }})) -eq 0 ] && echo "\"âœ… Clean\"" || echo "\"âš ï¸ Issues Found\""),
          "last_scan": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        )
        
        echo "report=$SECURITY_JSON" >> $GITHUB_OUTPUT

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
  performance-trend-analysis:
    name: Performance Trend Analysis
    runs-on: ubuntu-latest
    outputs:
      performance-report: ${{ steps.performance.outputs.report }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        cache: 'pip'
        
    - name: Analyze Performance Trends
      id: performance
      run: |
        echo "ğŸš€ Analyzing performance trends..."
        
        # éå»ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ç›£è¦–ãƒ„ãƒ¼ãƒ«ã®APIã‚’ä½¿ç”¨ï¼‰
        # ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        
        AVG_RESPONSE_TIME="1.2"
        P95_RESPONSE_TIME="2.8"
        ERROR_RATE="0.15"
        UPTIME="99.95"
        
        # ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®šï¼ˆç°¡ç•¥åŒ–ï¼‰
        RESPONSE_TREND="stable"  # improving, stable, degrading
        ERROR_TREND="improving"
        UPTIME_TREND="stable"
        
        PERFORMANCE_JSON=$(cat << EOF
        {
          "current_metrics": {
            "avg_response_time_seconds": $AVG_RESPONSE_TIME,
            "p95_response_time_seconds": $P95_RESPONSE_TIME,
            "error_rate_percent": $ERROR_RATE,
            "uptime_percent": $UPTIME
          },
          "trends": {
            "response_time": "$RESPONSE_TREND",
            "error_rate": "$ERROR_TREND",
            "uptime": "$UPTIME_TREND"
          },
          "targets": {
            "avg_response_time": 2.0,
            "p95_response_time": 5.0,
            "error_rate": 1.0,
            "uptime": 99.9
          },
          "status": {
            "response_time": $([ $(echo "$AVG_RESPONSE_TIME <= 2.0" | bc) -eq 1 ] && echo "\"âœ… Good\"" || echo "\"âŒ Slow\""),
            "error_rate": $([ $(echo "$ERROR_RATE <= 1.0" | bc) -eq 1 ] && echo "\"âœ… Good\"" || echo "\"âŒ High\""),
            "uptime": $([ $(echo "$UPTIME >= 99.9" | bc) -eq 1 ] && echo "\"âœ… Good\"" || echo "\"âŒ Low\"")
          }
        }
        EOF
        )
        
        echo "report=$PERFORMANCE_JSON" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Performance Status:"
        echo "  Avg Response: ${AVG_RESPONSE_TIME}s (target: 2.0s)"
        echo "  Error Rate: ${ERROR_RATE}% (target: <1%)"
        echo "  Uptime: ${UPTIME}% (target: >99.9%)"

  # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  generate-weekly-report:
    name: Generate Weekly CI/CD Report
    runs-on: ubuntu-latest
    needs: [collect-pipeline-metrics, analyze-test-coverage, security-scan-summary, performance-trend-analysis]
    
    steps:
    - name: Generate Comprehensive Report
      run: |
        # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
        METRICS='${{ needs.collect-pipeline-metrics.outputs.metrics-data }}'
        COVERAGE='${{ needs.analyze-test-coverage.outputs.coverage-report }}'
        SECURITY='${{ needs.security-scan-summary.outputs.security-report }}'
        PERFORMANCE='${{ needs.performance-trend-analysis.outputs.performance-report }}'
        
        # è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        cat > weekly-cicd-report.md << 'EOF'
        # ğŸ“Š é€±æ¬¡CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ
        
        **ç”Ÿæˆæ—¥**: $(date)
        **å¯¾è±¡æœŸé–“**: éå»7æ—¥é–“
        
        ## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµ±è¨ˆ
        
        EOF
        
        echo "$METRICS" | jq -r '
        "- **ç·ãƒ‡ãƒ—ãƒ­ã‚¤æ•°**: \(.deployments.total)
        - **æˆåŠŸãƒ‡ãƒ—ãƒ­ã‚¤æ•°**: \(.deployments.successful)
        - **æˆåŠŸç‡**: \(.deployments.success_rate)%
        - **å¹³å‡ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**: \(.deployments.avg_duration_minutes)åˆ†
        - **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ•°**: \(.rollbacks.total)
        
        $(if .deployments.success_rate >= 95 then "âœ… å„ªç§€" elif .deployments.success_rate >= 90 then "âš ï¸ æ³¨æ„" else "âŒ æ”¹å–„å¿…è¦" end)
        "' >> weekly-cicd-report.md
        
        cat >> weekly-cicd-report.md << 'EOF'
        
        ## ğŸ§ª ãƒ†ã‚¹ãƒˆçµ±è¨ˆ
        
        EOF
        
        echo "$METRICS" | jq -r '
        "- **ç·ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ•°**: \(.tests.total)
        - **æˆåŠŸãƒ†ã‚¹ãƒˆæ•°**: \(.tests.successful)  
        - **æˆåŠŸç‡**: \(.tests.success_rate)%
        
        $(if .tests.success_rate >= 95 then "âœ… å„ªç§€" elif .tests.success_rate >= 90 then "âš ï¸ æ³¨æ„" else "âŒ æ”¹å–„å¿…è¦" end)
        "' >> weekly-cicd-report.md
        
        cat >> weekly-cicd-report.md << 'EOF'
        
        ## ğŸ“ˆ ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
        
        EOF
        
        echo "$COVERAGE" | jq -r '
        "- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: \(.backend)% \(.status.backend)
        - **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: \(.frontend)% \(.status.frontend)
        - **ç·åˆã‚«ãƒãƒ¬ãƒƒã‚¸**: \(.overall)% \(.status.overall)
        
        ### ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™
        - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: \(.targets.backend)%
        - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: \(.targets.frontend)%
        - ç·åˆ: \(.targets.overall)%
        "' >> weekly-cicd-report.md
        
        cat >> weekly-cicd-report.md << 'EOF'
        
        ## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³
        
        EOF
        
        echo "$SECURITY" | jq -r '
        "- **Pythonä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§**: \(.dependencies.python_vulnerabilities)ä»¶
        - **Node.jsä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§**: \(.dependencies.nodejs_vulnerabilities)ä»¶
        - **ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: \(.overall_status)
        - **æœ€çµ‚ã‚¹ã‚­ãƒ£ãƒ³**: \(.last_scan)
        "' >> weekly-cicd-report.md
        
        cat >> weekly-cicd-report.md << 'EOF'
        
        ## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çŠ¶æ³
        
        EOF
        
        echo "$PERFORMANCE" | jq -r '
        "### ç¾åœ¨ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹
        - **å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: \(.current_metrics.avg_response_time_seconds)ç§’ \(.status.response_time)
        - **95ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«**: \(.current_metrics.p95_response_time_seconds)ç§’
        - **ã‚¨ãƒ©ãƒ¼ç‡**: \(.current_metrics.error_rate_percent)% \(.status.error_rate)  
        - **ç¨¼åƒç‡**: \(.current_metrics.uptime_percent)% \(.status.uptime)
        
        ### ãƒˆãƒ¬ãƒ³ãƒ‰
        - **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: \(.trends.response_time)
        - **ã‚¨ãƒ©ãƒ¼ç‡**: \(.trends.error_rate)
        - **ç¨¼åƒç‡**: \(.trends.uptime)
        "' >> weekly-cicd-report.md
        
        cat >> weekly-cicd-report.md << 'EOF'
        
        ## ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        
        ### é«˜å„ªå…ˆåº¦
        EOF
        
        # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆ
        DEPLOY_SUCCESS_RATE=$(echo "$METRICS" | jq -r '.deployments.success_rate')
        TEST_SUCCESS_RATE=$(echo "$METRICS" | jq -r '.tests.success_rate')
        ROLLBACK_COUNT=$(echo "$METRICS" | jq -r '.rollbacks.total')
        BACKEND_COVERAGE=$(echo "$COVERAGE" | jq -r '.backend')
        SECURITY_ISSUES=$(echo "$SECURITY" | jq -r '(.dependencies.python_vulnerabilities + .dependencies.nodejs_vulnerabilities)')
        
        if (( $(echo "$DEPLOY_SUCCESS_RATE < 90" | bc -l) )); then
          echo "- ğŸš¨ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ï¼ˆ${DEPLOY_SUCCESS_RATE}%ï¼‰ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã®è¦‹ç›´ã—ãŒå¿…è¦ã§ã™ã€‚" >> weekly-cicd-report.md
        fi
        
        if (( $(echo "$TEST_SUCCESS_RATE < 95" | bc -l) )); then
          echo "- âš ï¸ ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ï¼ˆ${TEST_SUCCESS_RATE}%ï¼‰ã€‚ãƒ†ã‚¹ãƒˆã®å®‰å®šæ€§å‘ä¸ŠãŒå¿…è¦ã§ã™ã€‚" >> weekly-cicd-report.md
        fi
        
        if [ "$ROLLBACK_COUNT" -gt 0 ]; then
          echo "- ğŸ”„ ${ROLLBACK_COUNT}å›ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ ¹æœ¬åŸå› ã®èª¿æŸ»ãŒå¿…è¦ã§ã™ã€‚" >> weekly-cicd-report.md
        fi
        
        if (( $(echo "$BACKEND_COVERAGE < 85" | bc -l) )); then
          echo "- ğŸ“ˆ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ï¼ˆ${BACKEND_COVERAGE}%ï¼‰ã€‚" >> weekly-cicd-report.md
        fi
        
        if [ "$SECURITY_ISSUES" -gt 0 ]; then
          echo "- ğŸ”’ ${SECURITY_ISSUES}ä»¶ã®ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå¿…è¦ã§ã™ã€‚" >> weekly-cicd-report.md
        fi
        
        cat >> weekly-cicd-report.md << 'EOF'
        
        ### ä¸­å„ªå…ˆåº¦
        - ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¶™ç¶šç›£è¦–
        - ğŸ”§ CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æœ€é©åŒ–æ¤œè¨
        - ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
        
        ### æ¬¡é€±ã®ç›®æ¨™
        - ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡: 95%ä»¥ä¸Šç¶­æŒ
        - ãƒ†ã‚¹ãƒˆæˆåŠŸç‡: 98%ä»¥ä¸Šç¶­æŒ  
        - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ç›®æ¨™å€¤é”æˆ
        - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§: 0ä»¶
        
        ---
        
        **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆè€…**: GitHub Actions
        **æ¬¡å›ãƒ¬ãƒãƒ¼ãƒˆ**: $(date -d '+7 days' +%Yå¹´%mæœˆ%dæ—¥)
        EOF
        
        echo "ğŸ“‹ é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
        
    - name: Upload Weekly Report
      uses: actions/upload-artifact@v4
      with:
        name: weekly-cicd-report
        path: weekly-cicd-report.md
        retention-days: 365
        
    - name: Create GitHub Issue for Report
      run: |
        # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’GitHub Issueã¨ã—ã¦ä½œæˆ
        REPORT_CONTENT=$(cat weekly-cicd-report.md)
        
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/issues \
          -d "{
            \"title\": \"ğŸ“Š é€±æ¬¡CI/CDãƒ¬ãƒãƒ¼ãƒˆ - $(date +%Y/%m/%d)\",
            \"body\": $(echo "$REPORT_CONTENT" | jq -R -s .),
            \"labels\": [\"report\", \"ci-cd\", \"weekly\"]
          }"
        
        echo "âœ… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’GitHub Issueã¨ã—ã¦ä½œæˆã—ã¾ã—ãŸ"

  # ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
  check-critical-issues:
    name: Check Critical Issues
    runs-on: ubuntu-latest
    needs: [collect-pipeline-metrics, analyze-test-coverage, security-scan-summary]
    
    steps:
    - name: Evaluate Critical Thresholds
      run: |
        echo "ğŸš¨ é‡è¦ãªé–¾å€¤ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        METRICS='${{ needs.collect-pipeline-metrics.outputs.metrics-data }}'
        COVERAGE='${{ needs.analyze-test-coverage.outputs.coverage-report }}'
        SECURITY='${{ needs.security-scan-summary.outputs.security-report }}'
        
        DEPLOY_SUCCESS_RATE=$(echo "$METRICS" | jq -r '.deployments.success_rate')
        TEST_SUCCESS_RATE=$(echo "$METRICS" | jq -r '.tests.success_rate')
        ROLLBACK_COUNT=$(echo "$METRICS" | jq -r '.rollbacks.total')
        SECURITY_ISSUES=$(echo "$SECURITY" | jq -r '(.dependencies.python_vulnerabilities + .dependencies.nodejs_vulnerabilities)')
        
        CRITICAL_ISSUES=0
        
        # ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
        if (( $(echo "$DEPLOY_SUCCESS_RATE < 80" | bc -l) )); then
          echo "ğŸš¨ CRITICAL: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡ãŒå±é™ºãªãƒ¬ãƒ™ãƒ«ã§ã™ (${DEPLOY_SUCCESS_RATE}%)"
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
        fi
        
        if (( $(echo "$TEST_SUCCESS_RATE < 85" | bc -l) )); then
          echo "ğŸš¨ CRITICAL: ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ãŒå±é™ºãªãƒ¬ãƒ™ãƒ«ã§ã™ (${TEST_SUCCESS_RATE}%)"
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
        fi
        
        if [ "$ROLLBACK_COUNT" -gt 3 ]; then
          echo "ğŸš¨ CRITICAL: éåº¦ãªãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™ºç”Ÿ (${ROLLBACK_COUNT}å›)"
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
        fi
        
        if [ "$SECURITY_ISSUES" -gt 10 ]; then
          echo "ğŸš¨ CRITICAL: æ·±åˆ»ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ (${SECURITY_ISSUES}ä»¶)"
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
        fi
        
        if [ $CRITICAL_ISSUES -gt 0 ]; then
          echo "âŒ $CRITICAL_ISSUES ä»¶ã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          
          # ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªé€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ï¼‰
          echo "ğŸš¨ ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã™..."
          
          exit 1
        else
          echo "âœ… ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
        fi
